<!DOCTYPE html>
  <html>
    <head>
      <title>details</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///C:\Users\hsontrop\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.3.5\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      

      <style> 
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <h1 class="mume-header" id="creating-vue-components-with-d3">creating vue components with d3</h1>

<h2 class="mume-header" id="introduction">Introduction</h2>

<p>D3 stands for <code>Data Driven Documents</code>. D3 can be used to create any chart imaginable using web standards only. The power of <code>d3.js</code> comes from its ability to bind data to the DOM and for being in incredibly powerful toolbelt library which serves as a visualization kernel. On the other hand, <code>vue</code> is a popular progressive framework for building user interfaces that is both easy to use and incrementally adoptable. Furthermore, vue offers a powerful template and rendering framework that let's us compose applications via a set of custom components we can create or reuse, combined with a very capable <code>reactive event system</code></p>
<p>These days every major framework has bindings to javascript. Hence, it makes sense to combine the power of <code>vue</code> and <code>d3</code> to create <code>reactive data driven visualization components</code> in an ES6 like way. As these components are completely javascript based, they can be used inside <code>.NET</code>, <code>Python</code> and <code>R/Shiny</code> applications, without modifying any code!</p>
<p>This text discusses the details of a technical prototype app that involves in a number of custom d3 driven bubble chart <code>components</code>, together with a <code>main vue app</code> and a <code>reactive event system</code> which let's the components communicate with each other, with the main vue app and even with R/Shiny. Importantly, this code can be copied verbatim and will still work inside javascript or R.</p>
<h4 class="mume-header" id="application-overview">application overview</h4>

<p>The app looks like this:</p>
<p><img src="app.PNG" alt="alt text" title="Logo Title Text 1"></p>
<p>We see a top level section, displaying some information, a set of 3 bubble charts and a lower section showing details of data received by R as send from the vue components.</p>
<p>Here each bubble plot is a <code>d3.js</code> based <code>vue component</code> that shows a number of circles as it's data, using a d3 scale to position them on an x-axis. The data for each chart is a simple array, containing numbers draw from a normal distribution. The data itself has no meaning, other than allowing us to draw some circles on them. The lower section is only visible when we render the components in R.</p>
<h4 class="mume-header" id="key-functionality">key functionality</h4>

<p>This toy application demonstrates a number of concepts:</p>
<ol>
<li>show how to encapsulate complex <code>d3.js</code> logic in a vue component</li>
<li>automatically resize components based on the parent container dimensions</li>
<li>make components react to data changes (props) send down from the parent (the main app) to the child components (the bubble components)</li>
<li>let component emit events based on <code>hover</code> and <code>click</code> events to their parent</li>
<li>as an alternative, use a global <code>event bus</code> to emit events between components, regardless if there is a child parent relationship</li>
<li>use the same components in both a vanilla javascript context <em>and</em> an R / shiny context, <em>without</em> changing a single line of code inside the components</li>
<li>show how to update components from <em>R</em></li>
<li>show how to send events from javascript to <em>R</em></li>
</ol>
<h3 class="mume-header" id="main-vue-instance">main vue instance</h3>

<p>The main vue instance, has an id of <code>app</code>, holds the 3 bubble chart instances. On the HTML side of things, the main vue app looks like this:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    ...

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</pre><p>The 3 bubble chart instances are created via custom <code>&lt;bubble-chart&gt;&lt;/bubble-chart&gt;</code> tags, which represent vue components. During the lifetime of the vue instances, the markup will be replaced with actual DOM nodes that make up the chart. Some of the nodes are created and controlled by vue, while others are created and controlled by d3 (more on this below).</p>
<p>On the javascript side of things, we first define a main vue app:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

   el<span class="token punctuation">:</span> <span class="token string">"#app"</span><span class="token punctuation">,</span>

   data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        width<span class="token punctuation">:</span> <span class="token number">960</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        timeline_data1<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        timeline_data2<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        timeline_data3<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        hover_payload<span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>We'll explain the details and other parts of the main vue instance below.</p>
<h3 class="mume-header" id="vue-components">vue components</h3>

<p>In addition to our main vue app, we also define a bubble chart component as follows:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">"bubble-chart"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    props<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
        &lt;div class = "custom">
            ...
            &lt;svg :id="id" width="100%" :height="height" ref="svg">&lt;/svg>
        &lt;/div>`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>Among other things discussed below, the components involves a <code>template</code> declaration, that asks vue to render a <code>div</code> with a <code>svg</code> nested inside it. During the lifetime of the <code>vue</code> component, the template is rendered to the DOM. At a later stage in the lifetime of our instance, we'll use <code>d3</code> to inject additional content into the <code>svg</code>. The outer <code>div</code> sets a CSS class that creates some additional room and render styles for our chart instance.</p>
<h4 class="mume-header" id="main-vue-data">main vue data</h4>

<p>The main app holds data on its container <code>width</code> and <code>height</code>, as well as some initial data for our bubble_charts i.e. <code>bubble_data1</code>, <code>bubble_data2</code> and <code>bubble_data3</code>. At a later stage, we use <code>hover_payload</code> field to store hover event data on the main app that is 'emitted' from the bubble charts when interacting with the various circle elements on <code>mouseover</code> events.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token number">960</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
    bubble_data1<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bubble_data2<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bubble_data3<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    hover_payload<span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="props">props</h4>

<p>Some of this data is passed down to the child components i.e. the bubble charts. In vue, <code>props</code>, which are the default way to pass data from a parent to a child component. You can think of <code>props</code> as custom attributes that can react to data changes. In our case, the bubble charts take the following props:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">"bubble-chart"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    props<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>On the HTML part, we can tell the main vue app to send down data as <code>props</code> as follows:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>chart1<span class="token punctuation">"</span></span> <span class="token attr-name">:width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">"</span></span> <span class="token attr-name">:height</span><span class="token attr-value"><span class="token punctuation">=</span>150</span> <span class="token attr-name">:data</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bubble_data1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
</pre><p>In our case, we pass two static props for both the <code>id</code> and chart <code>height</code>, while the chart <code>width</code> and <code>data</code> are reactive.</p>
<h3 class="mume-header" id="life-cycle-hooks">life cycle hooks</h3>

<p>As noted above, our custom bubble chart component receives a <code>width</code> prop from the parent:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span> <span class="token attr-name">:width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
</pre><p>The value of <code>width</code> in our case is determined in the main vue instance and send down to let each bubble chart know how much horizontal space it can consume.</p>
<p>How do we know what value for <code>width</code> to pass down as a prop?</p>
<p>Consider our main app. As an example, we use the <code>mounted</code> life cycle hook to attach an event handler to the main <code>window</code> object to listen for <code>resize</code> events.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

    el<span class="token punctuation">:</span> <span class="token string">"#app"</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    mounted<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setContainerDims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>setContainerDims<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token function">setContainerDims</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>setContainerDims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>In the code above, on the <code>mounted</code> life cycle hook, we attach a listener that listens for window <code>resize</code> events. When this event is triggered, we tell it to call the <code>setContainerDims</code> method we defined, which looks like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token function">setContainerDims</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Here <code>this.$el</code> refers to our app container, for which we probe the current <code>width</code> and <code>height</code>. Subsequently, we store these value on the vue instance.</p>
<p>Note that <code>this</code> here refers to the vue instance (more on the <code>this</code> context below).</p>
<p>Finally we use the <code>beforeDestroy</code> hook to remove the event listener when the vue instance is about to be destroyed.</p>
<p>There are several other life cycle hooks that can be used. Vue provides the following life cycle hooks: <code>beforeCreate</code>, <code>created</code>, <code>beforeMount</code>, <code>mounted</code>, <code>beforeUpdate</code>, <code>updated</code>, <code>beforeDestroy</code> and <code>destroyed</code>.</p>
<p>In summary, as soon as we observe a <code>window resize event</code>, the container main vue app is made aware of its new dimensions, which subsequently sends down a <code>width prop</code> to the child components. In turn, the bubble chart components can react to the new prop values and redraw themselves.</p>
<h3 class="mume-header" id="creating-a-d3js-based-bubble-chart">creating a d3.js based bubble chart</h3>

<p>Roughly, our bubble chart components looks like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">"bubble-chart"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    props<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    mounted<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>svg <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"#"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token operator">...</span>

        draw<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token operator">...</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
        &lt;div class = "custom">
            ...
            &lt;svg :id="id" width="100%" :height="height" ref="svg">&lt;/svg>
        &lt;/div>`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>Initially, we ask vue to create a simple <code>div</code>, containing an empty <code>svg</code> element, using the <code>template</code> option. This <code>svg</code> element serves as our base container in which d3 will operate.</p>
<p>For convenience, when the chart gets <code>mounted</code> to the DOM, we ask it to store a reference to the <code>svg</code> element, using <code>d3.select</code> and to store it on the vue component using <code>this.svg</code>. The later operation provides us with an easy handle to the svg container, which comes in handy later.</p>
<h3 class="mume-header" id="watch">watch</h3>

<p>Vue has a number of ways to listen and react to changes in data and or props. For instance, to create scales it's good to know the minimum and maximum values of the data that was passed to our component. For this we can use the d3 methods <code>d3.min</code> and <code>d3.max</code>. Furthermore, we can use vue's watch functionality to react to changes in our data:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>

    <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>min <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</pre><p>Here we told vue to watch for changes in <code>data</code>. Whenever a change is detected, it runs our handler, which in our case sets the <code>min</code> and <code>max</code> values and stores them on our component. To create some extra room, we added a margin of 20, which will come in handy later. In addition, we ask vue to run our <code>draw</code> method any time <code>data</code> changes. Here <code>draw</code> is a method we defined on our component that uses <code>d3.js</code> to draw a bubble chart. Let's see how we can use d3 to create a nice <code>draw</code> method.</p>
<h4 class="mume-header" id="the-draw-function">the draw function</h4>

<p>Besides providing an <code>svg</code> container element by <code>vue.js</code>, we leave all the drawing operations of our charts to <code>d3.js</code> as <code>d3.js</code> is especially suitable to manipulate and generate svg content. The pseudo code or our draw function looks like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">draw<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// create a scale function</span>

    <span class="token comment">// bind data to our base svg: the data join step</span>

    <span class="token comment">// apply the d3 enter, update exit pattern</span>
    <span class="token comment">// to create, update and remove svg circle elements</span>

<span class="token punctuation">}</span>
</pre><p>We first create a scale function.</p>
<h4 class="mume-header" id="creating-a-scale">creating a scale</h4>

<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> d3
  <span class="token punctuation">.</span><span class="token function">scaleLinear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>min<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In our case, we create a function <code>x</code> to helps us to position the values in our data to horizontal pixel coordinates. Tranforming input data to pixel data to position element on the screen is one of the most useful things d3 allow us to do, for which we often create a scale.</p>
<p>The <code>domain</code> of our scale represents the extent of our input data, while <code>range</code> represents the desired pixel range. In our case, we want this to be from the outer left of our chart i.e. <code>0</code>, to the the outer right i.e. to <code>width</code>. Note, here <code>x</code> represents a function, not a static value! This function can subsequently be used to interpolate values between the <code>min</code> and <code>max</code> values. For instance, if the domain would be [0,10] and the range would be [0,1600], then <code>x(0) = 0</code> and <code>x(10) = 1600</code>, while <code>x(5) = 800</code>.</p>
<h5 class="mume-header" id="data-join">data join</h5>

<p>This step is often called the <code>data join</code>. What does it 'join' you may ask? Well, in short it joins data the a <code>selection</code> of DOM nodes. In our case the data join step looks like this:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>svg<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token string">"circle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Likely, the data join is one of the most difficult and confusing steps in creating d3.js based charts! Here we ask d3 to <code>select</code> <em>all</em> the <code>circle</code> elements in our svg element (if any). Furthermore, for each element in our data, it also creates a <em>place holder</em>, which in a later step we can use to create or update elements with. Note there are 3 possible scenarios:</p>
<pre class="language-text">scenario A] : we have less circle elements than we have individual data elements
scenario B] : we have more circle elements than we have individual data elements
scenario C] : we have as much circle elements as we have individual data elements
</pre>
<p>In the world of <code>d3</code>, scenario A translates to the <code>enter</code> step, scenario B translates to the <code>exit</code> step and scenario C translates to the <code>update</code> step.</p>
<h5 class="mume-header" id="enter">enter</h5>

<p>to do ...</p>
<h5 class="mume-header" id="update">update</h5>

<p>to do ...</p>
<h5 class="mume-header" id="exit">exit</h5>

<p>to do ...</p>
<h3 class="mume-header" id="debounce">debounce</h3>

<p>Note that <code>data</code> in a vue context is <code>reactive</code>. For instance, in our case we passed the <code>width</code> data down to the child components via a <code>prop</code>:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span> <span class="token attr-name">:width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span> <span class="token attr-name">:width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bubble-chart</span> <span class="token attr-name">...</span> <span class="token attr-name">:width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bubble-chart</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</pre><p>Inside our <code>bubble-chart</code> components we use <code>watch</code> to listen for changes in the <code>width</code> <code>prop</code>:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">        Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">"bubble-chart"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

            <span class="token operator">...</span>

            watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>

                <span class="token operator">...</span>

                <span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    handler<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">debouncedDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

            <span class="token operator">...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>When this prop value changes, we call a handler, which in our case will special <code>draw</code> function (debouncedDraw), that will redraw the bubble chart.</p>
<p>The bubble chart receives a number of other <code>props</code> and creates a container <code>svg</code> element in which d3.js does it's thing.</p>
<p>Of note: besides creating the svg element, vue.js is not used to controll elements created inside the <code>svg</code> container i.e. we are not using <code>vue</code> for its virtual DOM, but mostly to encapsulate logic and for its client side reactivity system.</p>
<p>In the <code>methods</code> part we define a suitable <code>d3</code> based drawing function, simply called <code>draw</code>, which does all the required drawing operations, which are heavily using <code>d3</code>.</p>
<p>To limit the number of draw operations on resize events, we define a debounced version of the draw function in the <code>created</code> life cycle hook.</p>
<p>For convenience, we store the a selection of the base svg container when the vue instance is mounted, which we can access via <code>this.svg</code>, inside the vue instance.</p>
<p>During drawing we first bind all the data to the <code>svg</code> container, after which we apply a standard <code>enter</code>, <code>update</code> and <code>exit</code> d3 pattern. In the application, on data changes, <code>green</code> bubbles indicate new elements created via <code>enter</code>, <code>blue</code> bubbles indicate updated elements, while <code>exit</code> selections are shown as animated gray circles, that animate out of the screen, to both the left and right edges of the viewport.</p>
<p>Here we use the <code>watch</code> functionality to listen for changes to the data and the <code>width</code> prop, as passed down by the main app on resize events.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">"bubble-chart"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    props<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    created<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>debouncedDraw <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>draw<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    mounted<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>svg <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"#"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token operator">...</span>

        draw<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token operator">...</span>

            <span class="token comment">// bind data to base svg</span>
            <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>svg
                <span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token string">"circle"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// update</span>

            <span class="token comment">// enter</span>

            <span class="token comment">// exit</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            handler<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>min <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> d3<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            handler<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">debouncedDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
        &lt;div class = "custom">
            ...
            &lt;svg :id="id" width="100%" :height="height" ref="svg">&lt;/svg>
        &lt;/div>`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>To showcase some technical desired behavior the charts automatically resize themselves whenever the container the are in resizes i.e. due to a browser <code>window resize event</code>. Furthermore, the charts animate new data into position, while also removing old data in an animated way.</p>
<p>In order to do these we follow the well known <em>enter</em>, <em>update</em>, <em>exit</em> pattern by d3.js. See <a href="https://medium.com/@c_behrens/enter-update-exit-6cafc6014c36">here</a> for more info.</p>
<p>Last, the charts react to on <code>click</code>, on <code>hoverover</code> and on <code>hoverout</code> events when interacting with the circle element. In such cases the charts 'emit' events to the parent, the main vue instance.</p>
<p>The main purpose of this example is to demonstrate how we can encapsulate complex logic of a d3.js driven chart into a vue component. In that sense we are less interested here in the templating abilities of vue or it's performance benefits in terms of using a virtual DOM to control appearance.</p>
<p>Inside the <code>draw</code> method of the bubble chart we use a custom <code>emit</code> method to send data to shiny via the event bus. Note that inside <code>d3</code> functions (when we pass the data attribute <code>d</code>), we have a different <code>this</code> context than outside of the <code>d3</code> scope. Hence, sometimes we temporarily use <code>let vm = this</code> to store the vue instance <code>this</code> context so we can call vue methods inside <code>d3</code> functions.</p>
<p>When drawing, during the enter selection we attach various event listeners i.e. for <code>click</code>, <code>mouseover</code> and <code>mouseout</code> events.</p>
<p>The application uses a simple event bus to communicate messages between the components. The message bus is injected into every component via:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  $bus<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> EventBus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token operator">...</span>

<span class="token comment">// send messages to parent (main vue instance) from bubble component</span>
emit<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"event"</span><span class="token punctuation">:</span> type<span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span> <span class="token string">"index"</span><span class="token punctuation">:</span> index <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> event_name <span class="token operator">=</span> <span class="token string">"bubble-event"</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>event_name<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token operator">...</span>

draw<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token operator">...</span>

  <span class="token comment">// bind all data to svg container</span>
  <span class="token keyword">var</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>svg
    <span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token string">"circle"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">...</span>

  <span class="token comment">// d3 enter selection. We attach event listeners here</span>
  base<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"circle"</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>d<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"mouseover"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>d<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    vm<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"mouseover"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"mouseout"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>d<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    vm<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"mouseout"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>

<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="sending-events">sending events</h3>

<p>In the parent we can use the <code>v-on</code> directive to listen for these events. For instance, the code segment <code>v-on:bubble-event=&quot;showMessage&quot;</code> is saying: &quot;when the bubble chart emits an <code>bubble-event</code> event, call the <code>showMessage</code> method on the parent (the main vue instance) and pass whatever <code>payload</code> the bubble chart send upward. You can think of the payload as some data object holding the data that we want to pass upward.</p>
<p>As indicated above, on hover or click events, the bubble charts emit events. Each event we emit has a name e.g. <code>bubble-event</code>. Remember, in a vue context <code>props</code> are used to send information down, while we send information upward in the component tree by <code>emitting</code> events.</p>
<p>Note that the <code>emit</code> method on the vue bubble component emits events to its parent, the main vue app, under the name <code>bubble-event</code>.</p>
<p>In the main app, we can capture these events, by using the <code>v-on</code> directive:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span> ref<span class="token operator">=</span><span class="token string">"app"</span><span class="token operator">></span>

    <span class="token operator">...</span>

    <span class="token operator">&lt;</span>bubble<span class="token operator">-</span>chart v<span class="token operator">-</span>on<span class="token punctuation">:</span>bubble<span class="token operator">-</span>event<span class="token operator">=</span><span class="token string">"showMessage"</span> <span class="token operator">...</span>"<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>bubble<span class="token operator">-</span>chart<span class="token operator">></span>
    <span class="token operator">&lt;</span>bubble<span class="token operator">-</span>chart v<span class="token operator">-</span>on<span class="token punctuation">:</span>bubble<span class="token operator">-</span>event<span class="token operator">=</span><span class="token string">"showMessage"</span> <span class="token operator">...</span>"<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>bubble<span class="token operator">-</span>chart<span class="token operator">></span>
    <span class="token operator">&lt;</span>bubble<span class="token operator">-</span>chart v<span class="token operator">-</span>on<span class="token punctuation">:</span>bubble<span class="token operator">-</span>event<span class="token operator">=</span><span class="token string">"showMessage"</span> <span class="token operator">...</span>"<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>bubble<span class="token operator">-</span>chart<span class="token operator">></span>
</pre><p>The code segment <code>v-on:bubble-event=&quot;showMessage&quot;</code> is saying, when the bubble chart emits an event with name <code>bubble-event</code>, call the <code>showMessage</code> method on the parent (the main vue instance) and pass whatever payload the bubble chart passed over.</p>
<p>In the main app we define the <code>showMessage</code> method:</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

    el<span class="token punctuation">:</span> <span class="token string">"#app"</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>

        <span class="token operator">...</span>

        <span class="token function">showMessage</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token operator">...</span>

            <span class="token comment">// send data from main vue instance to event bus</span>
            <span class="token comment">// in turn, the event bus sends data to shiny</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">"shiny"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"input_id"</span><span class="token punctuation">:</span> <span class="token string">"bus"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"bus"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> payload <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>In our case the main vue app emits a <code>shiny</code> event and sends an object holding the original payload, augmented with some info that tells shiny on what <code>input_id</code> it can expect new data.</p>
<p>Finally, when our event bus receives a message on emitted with the <code>shiny</code> tags (as done by our main app), it calls it's own method 'shiny_emits', which uses a standard <code>Shiny.onInputChange</code> command to send data to shiny. In this case <code>$event</code> is the payload send along when emitted the <code>shiny</code> event, which contains an object that has a <code>input_id</code> key and a <code>data</code> key.</p>
<pre data-role="codeBlock" data-info="" class="language-"><code>// event bus
const EventBus = new Vue({

    created() {

        ...

        // listen for events to send data to shiny
        this.$on(&quot;shiny&quot;, this.shiny_emit);
    },

    methods: {
        ...

        // send data to shiny
        shiny_emit($event) {

            if (typeof Shiny !== &quot;undefined&quot;) {
                Shiny.onInputChange($event.input_id, $event.data);
            }
        }
    }
});
</code></pre><p>On the <code>R</code> side of things we can capture these events when listening to <code>input$bus</code> inside an observe block:</p>
<pre data-role="codeBlock" data-info="R" class="language-r">shinyServer<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment"># listen for data send from browser via event bus</span>
  output<span class="token operator">$</span>bus <span class="token operator">&lt;-</span> renderUI<span class="token punctuation">(</span><span class="token punctuation">{</span>

    req<span class="token punctuation">(</span>input<span class="token operator">$</span>bus<span class="token punctuation">)</span>

    tagList<span class="token punctuation">(</span>
      fluidRow<span class="token punctuation">(</span> id <span class="token operator">=</span> <span class="token string">"shiny_result"</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"received by shiny from vue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"type:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token operator">$</span>bus<span class="token operator">$</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"component id:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token operator">$</span>bus<span class="token operator">$</span>data<span class="token operator">$</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"event:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token operator">$</span>bus<span class="token operator">$</span>data<span class="token operator">$</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"data:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token operator">$</span>bus<span class="token operator">$</span>data<span class="token operator">$</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        column<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> h5<span class="token punctuation">(</span><span class="token string">"item index:"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token operator">$</span>bus<span class="token operator">$</span>data<span class="token operator">$</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token ellipsis">...</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>The app can send data from the vue components / vue app to shiny, but can also update data from shiny to the client.</p>
<p>Using <code>session$sendCustomMessage</code> we can send data to vue:</p>
<pre data-role="codeBlock" data-info="R" class="language-r">shinyServer<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment"># on updateVue, send some new data to the browser</span>
  observeEvent<span class="token punctuation">(</span>input<span class="token operator">$</span>updateVue<span class="token punctuation">,</span><span class="token punctuation">{</span>

      <span class="token comment"># number of items to generate</span>
      n1 <span class="token operator">&lt;-</span> floor<span class="token punctuation">(</span>runif<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> min<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      n2 <span class="token operator">&lt;-</span> floor<span class="token punctuation">(</span>runif<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> min<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      n3 <span class="token operator">&lt;-</span> floor<span class="token punctuation">(</span>runif<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> min<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment"># data object to send to javascript</span>
      payload <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span>

        <span class="token comment"># bubble data</span>
        data <span class="token operator">=</span> list<span class="token punctuation">(</span>
          bubble_data1 <span class="token operator">=</span> rnorm<span class="token punctuation">(</span>n1<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> sd<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          bubble_data2 <span class="token operator">=</span> rnorm<span class="token punctuation">(</span>n2<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> sd<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          bubble_data3 <span class="token operator">=</span> rnorm<span class="token punctuation">(</span>n3<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> sd<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      <span class="token comment"># run shiny handler on javascript with name shiny_update_vue</span>
      <span class="token comment"># and pass it our payload</span>
      session<span class="token operator">$</span>sendCustomMessage<span class="token punctuation">(</span><span class="token string">"shiny_update_vue"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>For simplicity, on the javascript side, we use a custom message handler to pass data directly into the main app.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Shiny <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Shiny<span class="token punctuation">.</span><span class="token function">addCustomMessageHandler</span><span class="token punctuation">(</span><span class="token string">"shiny_update_vue"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>bubble_data1 <span class="token operator">=</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bubble_data1<span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>bubble_data2 <span class="token operator">=</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bubble_data2<span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>bubble_data3 <span class="token operator">=</span> payload<span class="token punctuation">.</span>data<span class="token punctuation">.</span>bubble_data3<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Please see the code base for details on how to create a bubble chart via <code>d3</code> and for the remainder of various methods and other functions.</p>

      </div>
      
      
    </body>
    
    
    
    
    
    
    
  </html>